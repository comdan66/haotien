/*
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2015 - 2019, Ginkgo
 * @license     https://creativecommons.org/licenses/by-nc-nd/3.0/tw/ 姓名標示-非商業性-禁止改作 3.0 台灣 (CC BY-NC-ND 3.0 TW)
 * @link        https://www.ioa.tw/
 */

!function(t,e,n,i,o,a,l){t.GoogleAnalyticsObject=o,t.ga=t.ga||function(){(t.ga.q=t.ga.q||[]).push(arguments)},t.ga.l=1*new Date,a=e.createElement(n),l=e.getElementsByTagName(n)[0],a.async=1,a.src="https://www.google-analytics.com/analytics.js",l.parentNode.insertBefore(a,l)}(window,document,"script",0,"ga"),ga("create","UA-46121102-26","auto"),ga("send","pageview"),window.fbAsyncInit=function(){FB.init({appId:"640377126095413",xfbml:!0,version:"v2.4"})},function(t,e,n){var i,o=t.getElementsByTagName(e)[0];t.getElementById(n)||((i=t.createElement(e)).id=n,i.src="//connect.facebook.net/zh_TW/sdk.js",o.parentNode.insertBefore(i,o))}(document,"script","facebook-jssdk");var e=["AIzaSyBF02Xytwx2peyWWpiUwkQDgng_FYmnBaA"],t="1WRuhRwkEq0f0fmu_OYlJXPMfhJjPi0jPSiOL63ujsu0",p=[23.77133806905457,120.70937982351438],n=!1,i=!1,f=null,m=null,g=!1,v=[],w=null,_=null,y=null,b=1e4,x=null,T=null;function k(){return(new Date).getTime()}function M(t){this._div=null,this._option=Object.assign({className:"",top:0,left:0,width:32,height:32,html:"",map:null,position:null,css:{}},t),this._option.map&&this.setMap(this._option.map)}function P(){M.prototype=new google.maps.OverlayView,Object.assign(M.prototype,{setPoint:function(){if(this._div){if(!this._option.position)return this._div.style.left="-999px",void(this._div.style.top="-999px");if(this.getProjection()){var t=this.getProjection().fromLatLngToDivPixel(this._option.position);t&&(this._div.style.left=t.x-this._option.width/2+this._option.left+"px",this._div.style.top=t.y-this._option.height/2+this._option.top+"px")}}},draw:function(){this.setPoint()},onAdd:function(){for(var t in this._div=document.createElement("div"),this._div.style.position="absolute",this._div.className=this._option.className,this._div.style.width=this._option.width+"px",this._div.style.height=this._option.height+"px",this._div.innerHTML=this._option.html,this._option.css)"width"!=t&&"height"!=t&&"top"!=t&&"left"!=t&&"bottom"!=t&&"right"!=t&&(this._div.style[t]=this._option.css[t]);var e=this;google.maps.event.addDomListener(this._div,"click",function(t){t.stopPropagation&&t.stopPropagation(),google.maps.event.trigger(e,"click")}),this.getPanes().overlayImage.appendChild(this._div)},remove:function(){return this._div&&(this._div.parentNode.removeChild(this._div),this._div=null),this},setHtml:function(t){return this._option.html=t,this._div&&(this._div.innerHTML=this._option.html),this},getClassName:function(){return this._option.className},setClassName:function(t){return this._option.className=t,this._div&&(this._div.className=this._option.className),this},setPosition:function(t){return this.map&&(this._option.position=t,this.setPoint()),this},getPosition:function(){return this._option.position}})}function N(t){return new google.maps.LatLng(t[0][0],t[0][1])}function o(){i||(i=!0,p=N([p]),f&&f())}function j(){if(!n){n=!0,$(window).bind("gm",o);var t=e[Math.floor(Math.random()*e.length)];return $.getScript("https://maps.googleapis.com/maps/api/js?"+(t?"key="+t+"&":"")+"language=zh-TW&libraries=visualization&callback=gmc",o),!0}}function a(t){return null!==t}function l(t){return t.map&&t.setMap(null),null}function s(t,e,n,i,o){if(!t.length)return o?o([]):[];for(var a={},l=[],s=0;s<t.length;s++)if(void 0===a[s]){a[s]=!0;for(var r=[t[s]],u=s+1;u<t.length;u++)if(void 0===a[u]){var c=Math.max(Math.abs(t[s][0]-t[u][0]),Math.abs(t[s][0]-t[u][0]));if(30/Math.pow(2,e)/n<=c){if(i)break}else a[u]=!0,r.push(t[u])}else if(i)break;l.push(r)}return a=null,o?o(l):l}window.gmc=function(){$(window).trigger("gm")},$(function(){function n(t){return v.length?(null===w&&(w=new M({map:m,width:80,height:75,className:"nowMarker",html:'<img src="img/m4.png" />'})),w.setPosition(N(v))):null!==w&&w.setMap(null),t&&t()}function i(e){if(!g)return g=!0,$.get("https://spreadsheets.google.com/feeds/list/"+t+"/1/public/values?alt=json&t="+k(),function(t){return v=t.feed.entry.filter(function(t){return void 0!==t["gsx$時間戳記"].$t&&void 0!==t.gsx$latitudelongitude.$t}).map(function(t){var e=t.gsx$latitudelongitude.$t.split(",");if(e.length<2)return null;var n=e.map(function(t){return parseFloat(t)});return[n[0],n[1],t["gsx$時間戳記"].$t]}).filter(function(t){return null!=t}).reverse(),d.update(),e?e():n()}).fail(function(t,e){return l.hide(function(){o.empty().append($("<div />").attr("id","m").attr("data-emoticons",t).attr("data-error",e))})}.bind(null,"(ಥ﹏ಥ)","哭哭，取不到資料！")).always(function(){g=!1})}var o=$("body"),a=($("#map"),{exist:function(){return void 0!==a&&"undefined"!=typeof JSON},set:function(t,e){if(!this.exist())return!1;try{return localStorage.setItem(t,void 0===e?null:JSON.stringify(e)),!0}catch(t){return!1}},get:function(t){return!!this.exist()&&(val=localStorage.getItem(t),JSON.parse(val))}}),l={$el:null,$el2:null,timer:null,init:function(){null===l.$el&&(l.$el=$("<div />").attr("id","y").appendTo(o),l.$el2=$("<span />").appendTo(l.$el))},remove:function(){null!==l.$el&&l.$el.remove(),null!==l.$el2&&l.$el2.remove()},show:function(t,e){return l.init(),l.$el2.text(t),l.$el.addClass("show"),l.timer=setTimeout(function(){l.$el.addClass("ani"),setTimeout(function(){clearTimeout(l.timer),l.timer=null},300),e&&e()},100)},hide:function(t){function e(){return clearTimeout(l.timer),l.timer=null,l.$el.removeClass("ani"),setTimeout(function(){l.$el.removeClass("show"),l.remove(),t&&t()},300)}null!==l.timer?setTimeout(e,500):e()}},s={key:"haotien.ioa.tw",ttl:6e5,data:{},timeout:5e3,fail:null,get:function(e,n,t){var i=a.get(s.key);return i&&"object"==typeof i&&"number"==typeof i.t&&"object"==typeof i.v&&i.t+s.ttl>k()?n&&n(s.data=i.v):(setTimeout(function(){if(!1!==s.fail)return s.fail=!0,t&&t()},s.timeout),navigator.geolocation.getCurrentPosition(function(t){!0!==s.fail&&(s.fail=!1,s.data={lat:t.coords.latitude,lng:t.coords.longitude,acc:t.coords.accuracy},a.set(s.key,{t:k(),v:s.data}),e&&e(s.data),n&&n(s.data))},t,{enableHighAccuracy:!0}))}},r={$el:null,$el2:null,$el3:null,init:function(){null===r.$el&&(r.$el=$("<div />").attr("id","z").appendTo(o),r.$el2=$("<label />").attr("id","zi").click(function(){m.setZoom(m.zoom+1)}).appendTo(r.$el),r.$el3=$("<label />").attr("id","zo").click(function(){m.setZoom(m.zoom-1)}).appendTo(r.$el))},show:function(t){return r.init(),setTimeout(function(){return r.$el.addClass("s"),t&&t()},100)}},u={$el:null,datas:[{title:"浩天宮",links:[{text:"台中浩天宮大庄媽",href:"https://www.facebook.com/haotiengong/",class:"icon-7"}]},{title:"開發者",links:[{text:"楊協達",href:"https://www.facebook.com/zachtoshiya",class:"icon-8"},{text:"吳政賢",href:"https://www.facebook.com/comdan66",class:"icon-8"}]}],init:function(){null===u.$el&&(u.$el=$("<label />").attr("id","u").attr("for","_u").appendTo(o),$("<div />").attr("id","e").append($("<header />").append($("<b />").text("2019 大庄媽媽祖")).append($("<span />").text("GPS 即時定位")).append($("<label />").attr("for","_u"))).append($("<section />").append(u.datas.map(function(t){return $("<div />").attr("data-tip",t.title).append(t.links.map(function(t){return $("<a />").attr("href",t.href).text(t.text).attr("class",t.class).attr("target","_blank")}))}))).appendTo(o),$("<label />").attr("id","g").attr("for","_u").appendTo(o))},show:function(t){return u.init(),setTimeout(function(){return u.$el.addClass("s"),t&&t()},100)}},c={ed:!1,show:function(t){if(!c.ed)return c.ed=!0,$("#f").addClass("s"),t&&t()}},d={$el:null,data:0,init:function(){null===d.$el&&(d.$el=$("<div />").attr("id","l").text(d.data).appendTo(o))},update:function(){function t(t){return t*(Math.PI/180)}for(var e,n,i,o,a,l,s,r,u=0,c=1;c<v.length;c++)u+=(e=v[c-1][0],n=v[c-1][1],i=v[c][0],o=v[c][1],void 0,a=t(e),l=t(n),s=t(i),r=t(o),2*Math.asin(Math.sqrt(Math.pow(Math.sin((a-s)/2),2)+Math.cos(a)*Math.cos(s)*Math.pow(Math.sin((l-r)/2),2)))*6378137);d.data=(u/1e3).toFixed(2),null!==d.$el&&d.$el.text(d.data)},show:function(t){return d.init(),setTimeout(function(){return d.$el.addClass("s"),t&&t()},100)}},h={$el:null,init:function(){if(null===h.$el)return h.$el=$("<label />").attr("id","x").click(function(){null===_&&(_=new M({map:m,width:16,height:16,className:"myMarker",html:""})),_.setPosition(N([[s.data.lat,s.data.lng]])),m.setOptions({center:_.getPosition()})}).appendTo(o)},show:function(t){return s.get(null,function(){return h.init(),setTimeout(function(){return h.$el.addClass("s"),t&&t()},100)},t)}};f=function(){if(!m){if(m=new google.maps.Map($("#m").get(0),{zoom:7,clickableIcons:!1,disableDefaultUI:!0,gestureHandling:"greedy",center:p}),P(),m.addListener("click",function(t){console.error(t.latLng.lat()),console.error(t.latLng.lng())}),2<=v.length){var t=new google.maps.LatLngBounds;for(var e in v)t.extend(N([v[e]]));m.fitBounds(t)}else v.length&&(m.setCenter(N(v)),m.setZoom(12));l.hide(function(){r.show(function(){h.show(),c.show(function(){d.show(function(){u.show(function(){n(function(){m.addListener("idle",function(){m.zoom!==x&&(x=m.zoom,clearTimeout(T),T=setTimeout(n,300))}),y=setInterval(i,b)})})})})})})}},l.show("初始中…",i.bind(null,j))});